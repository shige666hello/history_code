name: Node.js Discussion Demo

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'è¦æ‰§è¡Œçš„æ“ä½œ'
        required: true
        default: 'demo'
        type: choice
        options:
          - demo
          - create-discussion
          - list-discussions
          - get-discussion-by-number
      discussion_number:
        description: 'è®¨è®ºç¼–å· (ä»…åœ¨ä½¿ç”¨ get-discussion-by-number æ—¶éœ€è¦)'
        required: false
        type: number
  push:
    branches: [ "main" ]
    paths:
      - 'package.json'
      - 'index.js'
      - 'discussion.js'

jobs:
  nodejs-discussion-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Run Node.js Discussion Demo
      if: github.event.inputs.action == 'demo' || github.event_name == 'push'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸš€ è¿è¡Œ Node.js Discussion æ¼”ç¤º"
        node discussion.js

    - name: Create Sample Discussion
      if: github.event.inputs.action == 'create-discussion'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ“ åˆ›å»ºç¤ºä¾‹è®¨è®º"
        node -e "
        const { GitHubDiscussionManager } = require('./index.js');
        const manager = new GitHubDiscussionManager(process.env.GITHUB_TOKEN, 'shige666hello', 'history_code');
        
        manager.getDiscussionCategories().then(categories => {
          if (categories.length > 0) {
            return manager.createDiscussion(
              'GitHub Actions åˆ›å»ºçš„è®¨è®º #' + Date.now(),
              'è¿™æ˜¯é€šè¿‡ GitHub Actions Workflow è‡ªåŠ¨åˆ›å»ºçš„è®¨è®ºã€‚\n\n## è‡ªåŠ¨åŒ–ä¿¡æ¯\n- åˆ›å»ºæ—¶é—´: ' + new Date().toISOString() + '\n- Workflow: Node.js Discussion Demo\n- è§¦å‘æ–¹å¼: workflow_dispatch\n\n## å…³äºŽ DiscussionNumber\nDiscussionNumber æ˜¯è®¨è®ºçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¯ä»¥é€šè¿‡ API èŽ·å–ã€‚',
              categories[0].id
            );
          }
        }).then(discussion => {
          console.log('âœ… è®¨è®ºå·²åˆ›å»º:');
          console.log('æ ‡é¢˜:', discussion.title);
          console.log('DiscussionNumber:', discussion.number);
          console.log('URL:', discussion.url);
          console.log('ID:', discussion.id);
        }).catch(err => {
          console.error('âŒ åˆ›å»ºå¤±è´¥:', err.message);
          process.exit(1);
        });
        "

    - name: List Discussions
      if: github.event.inputs.action == 'list-discussions'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ“‹ åˆ—å‡ºæ‰€æœ‰è®¨è®º"
        node -e "
        const { GitHubDiscussionManager } = require('./index.js');
        const manager = new GitHubDiscussionManager(process.env.GITHUB_TOKEN, 'shige666hello', 'history_code');
        
        manager.getDiscussions().then(discussions => {
          console.log('ðŸ“Š è®¨è®ºç»Ÿè®¡:');
          console.log('æ€»è®¨è®ºæ•°:', discussions.length);
          console.log('');
          
          if (discussions.length === 0) {
            console.log('å½“å‰æ²¡æœ‰è®¨è®º');
            return;
          }
          
          console.log('ðŸ“‹ è®¨è®ºåˆ—è¡¨:');
          discussions.forEach((discussion, index) => {
            console.log(\`\${index + 1}. #\${discussion.number} - \${discussion.title}\`);
            console.log(\`   ä½œè€…: \${discussion.author.login}\`);
            console.log(\`   åˆ†ç±»: \${discussion.category.name}\`);
            console.log(\`   åˆ›å»ºæ—¶é—´: \${discussion.createdAt}\`);
            console.log('');
          });
        }).catch(err => {
          console.error('âŒ èŽ·å–å¤±è´¥:', err.message);
          process.exit(1);
        });
        "

    - name: Get Discussion by Number
      if: github.event.inputs.action == 'get-discussion-by-number'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” èŽ·å–è®¨è®ºè¯¦æƒ…"
        node -e "
        const { GitHubDiscussionManager } = require('./index.js');
        const manager = new GitHubDiscussionManager(process.env.GITHUB_TOKEN, 'shige666hello', 'history_code');
        const discussionNumber = ${{ github.event.inputs.discussion_number || 1 }};
        
        console.log('èŽ·å–è®¨è®º #' + discussionNumber + ' çš„è¯¦æƒ…...');
        
        manager.getDiscussionByNumber(discussionNumber).then(discussion => {
          if (!discussion) {
            console.log('âŒ æœªæ‰¾åˆ°è®¨è®º #' + discussionNumber);
            return;
          }
          
          console.log('âœ… è®¨è®ºè¯¦æƒ…:');
          console.log('DiscussionNumber:', discussion.number);
          console.log('æ ‡é¢˜:', discussion.title);
          console.log('ä½œè€…:', discussion.author.login);
          console.log('åˆ†ç±»:', discussion.category.name);
          console.log('åˆ›å»ºæ—¶é—´:', discussion.createdAt);
          console.log('å†…å®¹é¢„è§ˆ:', discussion.body.substring(0, 200) + '...');
          console.log('è¯„è®ºæ•°:', discussion.comments.nodes.length);
          
          if (discussion.comments.nodes.length > 0) {
            console.log('');
            console.log('ðŸ’¬ æœ€æ–°è¯„è®º:');
            discussion.comments.nodes.slice(0, 5).forEach((comment, index) => {
              console.log(\`\${index + 1}. \${comment.author.login}: \${comment.body.substring(0, 100)}...\`);
            });
          }
        }).catch(err => {
          console.error('âŒ èŽ·å–å¤±è´¥:', err.message);
          process.exit(1);
        });
        "

    - name: Generate Discussion Report
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ“Š ç”Ÿæˆè®¨è®ºæŠ¥å‘Š"
        node -e "
        const { GitHubDiscussionManager } = require('./index.js');
        const fs = require('fs');
        const manager = new GitHubDiscussionManager(process.env.GITHUB_TOKEN, 'shige666hello', 'history_code');
        
        Promise.all([
          manager.getDiscussionCategories(),
          manager.getDiscussions()
        ]).then(([categories, discussions]) => {
          const report = {
            timestamp: new Date().toISOString(),
            repository: 'shige666hello/history_code',
            categories: categories.length,
            totalDiscussions: discussions.length,
            discussions: discussions.map(d => ({
              number: d.number,
              title: d.title,
              author: d.author.login,
              category: d.category.name,
              createdAt: d.createdAt
            }))
          };
          
          const reportContent = JSON.stringify(report, null, 2);
          console.log('è®¨è®ºæŠ¥å‘Š:');
          console.log(reportContent);
          
          // ä¿å­˜æŠ¥å‘Šä¸º artifact
          fs.writeFileSync('discussion-report.json', reportContent);
          console.log('æŠ¥å‘Šå·²ä¿å­˜åˆ° discussion-report.json');
        }).catch(err => {
          console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', err.message);
        });
        "

    - name: Upload Discussion Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: discussion-report
        path: discussion-report.json
        retention-days: 90

    - name: Create Summary
      if: always()
      run: |
        echo "## ðŸ“Š Node.js Discussion æ¼”ç¤ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Workflow æ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æ“ä½œä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- æ“ä½œç±»åž‹: ${{ github.event.inputs.action || 'demo' }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰§è¡Œæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ä»“åº“: shige666hello/history_code" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ å¯ç”¨çš„æ“ä½œ" >> $GITHUB_STEP_SUMMARY
        echo "- \`demo\`: è¿è¡Œå®Œæ•´çš„æ¼”ç¤º" >> $GITHUB_STEP_SUMMARY
        echo "- \`create-discussion\`: åˆ›å»ºç¤ºä¾‹è®¨è®º" >> $GITHUB_STEP_SUMMARY
        echo "- \`list-discussions\`: åˆ—å‡ºæ‰€æœ‰è®¨è®º" >> $GITHUB_STEP_SUMMARY
        echo "- \`get-discussion-by-number\`: èŽ·å–ç‰¹å®šç¼–å·çš„è®¨è®º" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“š DiscussionNumber è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "DiscussionNumber æ˜¯ GitHub Discussions çš„å”¯ä¸€æ•°å­—æ ‡è¯†ç¬¦ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼èŽ·å–:" >> $GITHUB_STEP_SUMMARY
        echo "- API: \`discussion.number\`" >> $GITHUB_STEP_SUMMARY
        echo "- GraphQL: \`discussion { number }\`" >> $GITHUB_STEP_SUMMARY
        echo "- REST API: \`GET /repos/{owner}/{repo}/discussions\`" >> $GITHUB_STEP_SUMMARY
